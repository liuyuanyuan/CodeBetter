# 分布式系统的幂等性

[TOC]

## 幂等性概念：

幂等一词源自数学概念，在程序中如果相同条件下多次请求对资源的影响表现一致则称请求为幂等请求，对应的接口为幂等接口。

## 幂等与去重处理:

#### 1 使用数据库的主键、唯一索引：防止重复数据插入；

特点：只在数据库环节实现幂等性，实现方法简单；但通用性差，也无法解决并发请求对应用服务的消耗；

#### 2 使用分布式锁

分布式锁一般适用于需要长时间处理的任务，在任务处理期间防止重复请求，如数据导出、复杂计算等，由于这些操作本身就要求串行处理，所以加锁对性能地影响有限（锁粒度为请求条件）。

#### 3 缓存请求URI并设定超时时长

URI 做为请求的 accessToken 再加上过期时间，比如 `PUT /user/001` 幂等有效时间30s，则在30s内同一个URI请求都视为重复直接过滤，这种做法可简化请求方操作，但仅限于REST请求且符合REST规范。

#### 4 将请求放入MQ然后再进行处理

主流的 MQ 在 `autocommit=true` 时天然实现了幂等（ACK：autocommit callback）；但考虑业务处理可能出错的情况我们一般会设置为 `autocommit=false` ，在业务处理成功后再提交，这时就需要使用上述幂等方案了：在接收到消息时写入请求 accessToken 以实现去重判断（Token 可为 Topic+Offset）提交后删除Token，整体上可以做到对业务透明。



## 幂等性与dos攻击预防(todo)：





## 编码实践