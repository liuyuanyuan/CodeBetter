# 异构数据迁移





## 分布式+集群系统监控

- 分布式：一个业务分拆成多个子业务，或者本身就是不同的业务，部署在不同的服务器上。

- 集群：同一个业务，部署在多个服务器上。（集群内每个结点的数据必须保持一致）

分布式中间件：请求**根据业务**转发给对应的业务DB结点；

读写分离集群中间件：根据**读写**转发给不同的DB结点；

集群中间件：请求**根据负载均衡分发策略**转发给DB结点；

> 一般来说负载均衡设备都会默认支持多种负载均衡分发策略，例如：
>
> - 轮询（RoundRobin）将请求顺序循环地发到每个服务器。当其中某个服务器发生故障，AX就把其从顺序循环队列中拿出，不参加下一次的轮询，直到其恢复正常。
> - 比率（Ratio）：给每个服务器分配一个加权值为比例，根椐这个比例，把用户的请求分配到每个服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。
> - 优先权（Priority）：给所有服务器分组，给每个组定义优先权，将用户的请求分配给优先级最高的服务器组（在同一组内，采用预先设定的轮询或比率算法，分配用户的请求）；当最高优先级中所有服务器或者指定数量的服务器出现故障，AX将把请求送给次优先级的服务器组。这种方式，实际为用户提供一种热备份的方式。
> - 最少连接数（LeastConnection）：AX会记录当前每台服务器或者服务端口上的连接数，新的连接将传递给连接数最少的服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。
> - 最快响应时间（Fast Reponse time）：新的连接传递给那些响应最快的服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。
> - 哈希算法( hash): 将客户端的源地址，端口进行哈希运算，根据运算的结果转发给一台服务器进行处理，当其中某个服务器发生故障，就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。
> - 基于数据包的内容分发：例如判断HTTP的URL，如果URL中带有.jpg的扩展名，就把数据包转发到指定的服务器。





## 迁移全家桶

### [不停机异构迁移的原理：将宝贵的停机时间留给业务层](https://developer.aliyun.com/article/59323)

(1) 结构迁移，结构定义迁移，例如表结构
(2) 全量数据迁移，源实例中存量数据迁移
(3) 增量数据迁移，将源实例迁移过程产生的业务更新数据同步到目标实例

增量数据迁移的增量日志拉取及解析模块，在迁移任务开始后便开始运行，源实例产生的任何业务更新数据，都会被日志拉取程序获取、解析并存储在DTS存储系统中。当全量数据迁移完成后，DTS启动增量数据回放模块，增量数据回放模块，会从DTS存储系统中读取源库的增量数据，经过解析、过滤、封装后同步到目标实例中。
由于源实例业务产生的增量数据的速度低于DTS增量同步的速度，所以经过一段时间的增量数据同步，目标实例跟源实例的数据同步会达到动态一致的过程。当增量迁移达到无延迟状态后，可以在目标实例进行业务测试，业务测试通过后，源实例业务停写，等待增量迁移同步再次达到无延迟后，直接将业务切换到目标实例。
由上面的流程可见，整个迁移过程中，业务停机时间为：从业务停写，增量数据完全追平，到业务切换到目标实例的时间，停机时间可以降低到1分钟以内。

<img src="/Users/liuyuanyuan/Library/Application Support/typora-user-images/image-20200922194254231.png" alt="image-20200922194254231" style="zoom:50%;" />

<img src="http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/6214948951/p46584.png" alt="数据同步工作原理" style="zoom:50%;" />







迁移任务评估

- 对象及其数据量
- 过程语言数量及语法差异

- 应用SQL语法差异



结构迁移

- 对象结构迁移

- 过程语言(plsql)转换迁移(antlr 解析后转换)



应用迁移

- 应用换库(更换数据库驱动、数据源、连接池配置)
- 应用SQL统计(数据库日志、应用日志)及转换



数据迁移

- 数据全量迁移+记录增量start position+开启增量DML追踪、解析、记录(REDO LOG)

- 数据增量追平



应用换库后的性能评估及优化

- 批量压力测试（应用接口、SQL压测）、分析报告(QPS、TPS)、给出优化建议(可以在工具中封装压测工具)

- 内部公测

  

校验及最终矫正一致

- 对象及其结构比对(rownum 分片，主键>唯一索引>rowid作为无主键表的compare key)

- 数据比对及矫正

  通过主键/rowid进行匹配，然后逐字段进行比对；



函数、存储过程、过程语言校验

- 语法校验：只要可以执行就证明语法是正确的；
- 结果校验：将源库和目标库进行备份，然后在备份库中分别执行函数等，对结果进行校验；

